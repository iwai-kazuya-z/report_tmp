# Dorapita DB関連Issue分析レポート

生成日時: 2025-12-25
分析期間: 2025-01-06 〜 2025-12-24
分析対象: ZIGExN/dorapita リポジトリ

---

## エグゼクティブサマリー

### 概要
- **総DB関連issue数**: 139件
- **Open**: 36件 (25.9%)
- **Closed**: 103件 (74.1%)
- **平均解決時間**: 39.3日

### 重大な懸念事項

1. **PostgreSQL→MySQL移行プロジェクトが停滞**
   - 20件の移行関連issue、うち4件がOpen（2025年7月開始から5ヶ月経過）
   - 最重要issue #2783（被参照15回）が未完了

2. **view_logsテーブルの肥大化が継続的な問題**
   - 11件のissueが発生、瞬断やパフォーマンス問題の原因
   - データ削減後も引き続き監視が必要

3. **セキュリティインシデント発生（2025年11月）**
   - SQLインジェクション試行と不正アクセスが発生
   - 5件のセキュリティ関連issue

4. **本番SQL更新の頻度が高い（11件）**
   - 手動オペレーションによるリスク継続

---

## 1. 時系列トレンド分析

### 月別issue作成数

| 月 | 総数 | Open | Closed | 特徴 |
|----|------|------|--------|------|
| 2025-12 | 9 | 8 | 1 | 開発規約・VNリソース整備など体制整備に注力 |
| 2025-11 | 17 | 6 | 11 | SQLインジェクション対応、recruitsテーブル削除Phase2 |
| 2025-10 | 20 | 10 | 10 | **ピーク月**：DB統合プロジェクト本格化、view_logs削減 |
| 2025-09 | 18 | 1 | 17 | 旧データアーカイブ計画、影響範囲調査 |
| 2025-08 | 31 | 10 | 21 | **最多月**：PostgreSQL→MySQL移行準備、テーブル削除調査 |
| 2025-07 | 11 | 1 | 10 | DB統合プロジェクト始動、view_logsバッチ問題 |
| 2025-06 | 5 | 0 | 5 | PostgreSQL→MySQL統合差分調査 |
| 2025-05 | 6 | 0 | 6 | DevOps改善、電話番号認証実装 |
| 2025-04 | 4 | 0 | 4 | Looker Studio × Cloud SQL連携 |
| 2025-03 | 3 | 0 | 3 | 本番SQL更新（原稿削除） |
| 2025-01 | 15 | 0 | 15 | plansTable改修、ステージング環境構築 |

**ピーク期**: 2025年8月〜10月（合計69件、全体の49.6%）

### トレンド分析

```
35┤                   ●
30┤                   │
25┤                   │
20┤               ●   ●
15┤           ●   │   │   ●
10┤     ●     │   │   │   │   ●
 5┤     │ ●   │   ●   │   │   │
 0└─────┴─┴───┴───┴───┴───┴───┴─────
   01  03  05  07  09  11  12 (月)
```

**解釈**:
- 7月のDB統合プロジェクト開始後、8〜10月に活動が集中
- 11月はセキュリティインシデント対応にリソースを割いた
- 12月は体制整備・プロセス標準化にシフト

---

## 2. カテゴリ別分析

### カテゴリ別issue統計

| カテゴリ | 総数 | Open | Closed | クローズ率 | 主な課題 |
|---------|------|------|--------|-----------|---------|
| **その他** | 62 | 17 | 45 | 72.6% | 開発プロセス、権限管理、調査依頼 |
| **PostgreSQL→MySQL移行** | 20 | 4 | 16 | 80.0% | **停滞中**、Phase1完了、Phase2未着手 |
| **スキーマ変更** | 15 | 7 | 8 | 53.3% | テーブル削除、plansTable改修 |
| **view_logsテーブル** | 11 | 1 | 10 | 90.9% | データ削減完了、監視継続 |
| **SQL更新（本番）** | 11 | 0 | 11 | 100.0% | 手動オペレーション、自動化検討が必要 |
| **Cloud SQL（インフラ）** | 6 | 1 | 5 | 83.3% | スケーリング、メンテナンス対応 |
| **セキュリティ** | 5 | 1 | 4 | 80.0% | SQLインジェクション試行、対策実施済み |
| **recruitsテーブル** | 4 | 2 | 2 | 50.0% | 旧データ削除Phase2実施中 |
| **パフォーマンス** | 3 | 3 | 0 | 0.0% | **全てOpen**、継続的な課題 |
| **データ移行** | 2 | 0 | 2 | 100.0% | BigQuery移行調査、Migration注意事項 |

### カテゴリ別の詳細分析

#### 2.1 PostgreSQL→MySQL移行（20件、4件Open）

**背景**:
- MySQL 5.7のEOL対応とDB統合を目的に2025年7月開始
- 既存のPostgreSQL（10.23）とMySQL（5.7）の二重管理を解消
- 新規MySQL 2台構成（8.0 LTS）への移行計画

**主要issue**:

| issue# | タイトル | 状態 | 被参照 | 備考 |
|--------|---------|------|--------|------|
| #2783 | PostgreSQL → MySQL 移行（既存＋新規2台構成） | Open | 15回 | **最重要issue** |
| #3602 | DB統合プロジェクト全体構成（最新版） | Open | - | 親issue |
| #3595 | MySQL一本化 × Replica運用 の戦略と計画 | Open | - | 運用計画 |
| #3258 | Delete unused views (PostgreSQL → MySQL Migration) | Open | - | クリーンアップ |

**完了したマイルストーン**:
- ✅ Phase0: ローカル検証 (#3105, #3033)
- ✅ Phase1: 事前調査 (#3165, #3063)
- ✅ 差分調査・再着手準備 (#2436, #2515)
- ✅ テーブル削除可否調査 (#3341, #3184, #3130)

**未完了タスク**:
- ❌ Phase2: 本番移行実施
- ❌ Replica構成の構築
- ❌ 未使用viewの削除

**ブロッカー**:
1. view_logs肥大化問題の解決が前提条件
2. recruitsテーブル旧データ削除の完了待ち
3. 本番リリース手順の確定が未完

**推奨アクション**:
- 2025年Q1までに本番移行スケジュールを確定
- MySQL 5.7のEOL（2025年10月）を考慮し、優先度を最高に設定

---

#### 2.2 view_logsテーブル（11件、1件Open）

**問題の概要**:
- PostgreSQL側のview_logsテーブルが肥大化し、瞬断やパフォーマンス問題を引き起こした
- MySQL→PostgreSQL同期バッチが原因

**主要issue**:

| issue# | タイトル | 状態 | 被参照 | 備考 |
|--------|---------|------|--------|------|
| #3515 | PostgreSQL：view_logsテーブル 同期済データ削除 | Closed | 5回 | 432件の他issueから参照 |
| #3689 | view_logsテーブルのクエリ遅延に関する対応検討 | Open | - | 継続監視 |
| #3691 | view_logs データ削減の効果測定 | Closed | - | 効果確認済み |
| #3548 | dorapitaサイト瞬断対応ーPgSQL view_logs Table 軽量化 | Closed | - | メンテナンス完了 |
| #2931 | Spotty downtime from `view_logs` batch | Closed | 3回 | 瞬断の原因特定 |

**実施した対策**:
1. PostgreSQL側のMySQL同期済みデータを削除 (#3515, #3162)
2. 旧データのGCSアーカイブ (#3459, #3507)
3. 影響範囲調査とテスト実施 (#3489, #3447)
4. 効果測定 (#3691)

**成果**:
- ✅ 瞬断問題の解消
- ✅ クエリパフォーマンスの改善
- ✅ PostgreSQL負荷の軽減

**残存課題**:
- ⚠️ クエリ遅延の継続監視（#3689）
- ⚠️ 同期バッチのボトルネック調査（#3896）

---

#### 2.3 recruitsテーブル（4件、2件Open）

**問題の概要**:
- PostgreSQL側のrecruitsテーブルに約7万件/約600MBの旧データが蓄積

**主要issue**:

| issue# | タイトル | 状態 | 備考 |
|--------|---------|------|------|
| #3638 | PostgreSQL recruitsテーブル旧データ削除（Phase 1：影響調査） | Open | Phase1実施中 |
| #3883 | PostgreSQL recruitsテーブル旧データ削除（Phase 2：開発・UT） | Open | Phase2実施中 |
| #3490 | 旧データアーカイブの影響範囲調査 | Closed | 妥当性評価完了 |
| #3406 | Search Page Query Optimization for Recruits Table | Closed | クエリ最適化完了 |

**進捗状況**:
- ✅ Phase 1: 影響範囲調査（#3490）
- 🔄 Phase 2: 開発・UT（#3883）実施中
- ❌ Phase 3: 本番デプロイ（未着手）

**推奨アクション**:
- Phase2の早期完了（2025年Q1目標）
- view_logsと同様のアーカイブ戦略を適用

---

#### 2.4 SQL更新（本番）（11件、0件Open）

**問題の概要**:
- 本番環境での手動SQL更新が頻発（11件）
- マイグレーション機能が未整備

**主要issue**:

| issue# | タイトル | 実施内容 |
|--------|---------|---------|
| #3927 | 【本番SQL更新】「勤務開始時間」の手動追加 | user_profile_work_start_times |
| #3864 | 【本番SQL更新】user_profile_menkyo_items等 | 複数テーブル |
| #3839 | 【本番SQL更新】PgSQLの特定原稿72009の削除 | recruits |
| #3836 | 【本番SQL更新】send_mails | send_mails |
| #3831 | 【本番SQL更新】send_mails | send_mails |
| #3294 | PgSQL更新の非特権化・短時間メンテ適用 | 所有者正規化 |
| #3088 | 【本番SQL更新】「勤務開始時間」の手動追加（備忘録） | 備忘録 |
| #1213 | 【本番SQL更新】PgSQL原稿削除（ms_code=66294） | recruits |
| #1051 | 【本番SQL更新】PgSQL原稿削除（ms_code=62505） | recruits |
| #939 | 【本番SQL更新】PgSQL原稿削除（ms_code=62245） | recruits |
| #902 | 【本番SQL更新】PgSQL原稿削除（ms_code=63485） | recruits |

**パターン分析**:
- **原稿削除**: 7件（recruits, send_mails）
- **テーブル追加・変更**: 3件（user_profile関連）
- **運用改善**: 1件（非特権化）

**リスク**:
- 手動オペレーションによるヒューマンエラー
- ロールバック手順が不明確
- 本番メンテナンス時間の発生

**推奨アクション**:
1. マイグレーション機能の実装（CakePHP Migrations）
2. 本番SQL更新チェックリストの整備
3. 自動ロールバック機能の実装

---

#### 2.5 セキュリティ（5件、1件Open）

**インシデント概要**:
- 2025年11月13日にSQLインジェクション試行と不正アクセスを検知

**関連issue**:

| issue# | タイトル | 状態 | 実施内容 |
|--------|---------|------|---------|
| #3854 | SQLi 再現結果の共有＋ユーザー多重作成脆弱性の対応 | Open | 対応中 |
| #3844 | SQL Injection – Local Reproduction Test | Closed | ローカル再現 |
| #3837 | 不正アクセス被害調査報告 | Closed | 調査完了 |
| #3834 | 不審アクセス（SQLインジェクション試行／スパム登録） | Open | 調査報告 |
| #3829 | Incident Report — SQL Injection Attempt | Closed | インシデント報告 |
| #3830 | Impact Scope Investigation for Unauthorized Bot Access | Closed | 影響範囲調査 |

**検出された脆弱性**:
1. SQLインジェクション試行（詳細不明、要確認）
2. ユーザー多重作成脆弱性

**対策状況**:
- ✅ インシデント報告完了
- ✅ 影響範囲調査完了
- ✅ ローカル再現テスト完了
- 🔄 脆弱性修正対応中（#3854）

**推奨アクション**:
- 脆弱性修正の早期完了
- WAF（Cloud Armor）ルールの見直し
- 定期的なセキュリティ監査の実施

---

#### 2.6 パフォーマンス（3件、3件Open）

**全てOpenの継続的な課題**:

| issue# | タイトル | 問題内容 |
|--------|---------|---------|
| #3977 | 原稿更新時のMySQL→PostgreSQL同期バッチで瞬断・高エラー率 | **最新の瞬断問題** |
| #3725 | 瞬断継続の原因調査 | 根本原因調査中 |
| #3512 | Improve Performance of Kanri/oubo (search function) | 検索機能の遅延 |

**特に重大な問題: #3977**
- 原稿更新時のMySQL→PostgreSQL同期バッチが原因
- 瞬断と高エラー率が発生
- view_logs削減後も問題が継続

**被参照関係**:
- #3725 → #3515, #3521, #3740, #3809（5件のissueを参照）

**推奨アクション**:
- 最優先で#3977の原因特定と対策実施
- 同期バッチのアーキテクチャ見直し
- 非同期処理やキューイングの導入検討

---

#### 2.7 Cloud SQL（インフラ）（6件、1件Open）

**主要issue**:

| issue# | タイトル | 内容 | 状態 |
|--------|---------|------|------|
| #3806 | Cloud SQL 自動メンテナンスReschedule対応 | MySQL/PostgreSQL | Closed |
| #3748 | Cloud SQL（pg-120011）スケールダウン対応 | コスト最適化 | Closed |
| #3719 | Cloud SQL（pg-120011）スケールアップ対応依頼 | CPU 90%超過 | Closed |
| #3529 | `api.dorapita.com` 新設（Cloud Run × Cloud SQL 5.7）計画 | 新規API | Closed |
| #3295 | CloudSQL8.0の延長サポート対応 | アップデート推奨 | Open |
| #1669 | Looker Studio × Cloud SQL ダッシュボード構築 | BI連携 | Closed |

**課題**:
- PostgreSQL（pg-120011）のCPU使用率が不安定
- MySQL 5.7のEOL対応が未完（#3295）

**推奨アクション**:
- MySQL 8.0へのアップグレード（2025年Q1目標）
- Cloud SQL Insights導入による継続監視

---

#### 2.8 スキーマ変更（15件、7件Open）

**主なテーブル操作**:

| 操作 | issue数 | 主なテーブル |
|------|--------|------------|
| テーブル削除 | 6 | ng_messages, jobtype_area_ranks, tel_logs, word_logs |
| データクリーンアップ | 5 | view_logs, entry_logs, use_numbers, send_mails |
| テーブル追加・変更 | 4 | plansTable, entriesテーブル |

**未完了のテーブル削除（Open）**:

| issue# | テーブル | 備考 |
|--------|---------|------|
| #3271 | ng_messages | 削除可否調査済み |
| #3270 | jobtype_area_ranks | 削除可否調査済み |
| #3164 | tel_logs | ログテーブル刷新の一環 |
| #3163 | word_logs | ログテーブル刷新の一環 |
| #3241 | use_numbers（旧データ） | 旧データのみ削除 |
| #3239 | send_mails（旧データ） | 旧データのみ削除 |

**推奨アクション**:
- 削除可否調査済みのテーブルを速やかに削除
- PostgreSQL→MySQL移行完了後に一括クリーンアップ

---

## 3. 頻出問題パターン

### 3.1 データ肥大化問題

**パターン**:
- 大量のログデータや履歴データがPostgreSQL側に蓄積
- 定期的なクリーンアップ機能が未実装

**該当issue**:
- view_logsテーブル（11件）
- recruitsテーブル（4件）
- entry_logs, tel_logs, word_logs

**根本原因**:
1. PostgreSQL→MySQLの二重管理
2. データ保持ポリシーの未整備
3. アーカイブ機能の欠如

**対策**:
- ✅ view_logs: GCSアーカイブ + 削除完了
- 🔄 recruits: Phase2実施中
- ❌ その他ログテーブル: 未着手

### 3.2 同期バッチの問題

**パターン**:
- MySQL→PostgreSQL同期バッチが原因で瞬断やパフォーマンス問題が発生

**該当issue**:
- #3977: 原稿更新時の同期バッチで瞬断・高エラー率
- #3896: プレビュー機能実行によるボトルネック
- #2931: view_logsバッチによる瞬断

**根本原因**:
1. 同期処理が同期的（リアルタイム）
2. トランザクションが長時間ロックを保持
3. バッチサイズの未調整

**推奨アクション**:
- 非同期処理への移行（Cloud Tasks / Pub/Sub）
- バッチサイズの最適化
- リトライロジックの実装

### 3.3 手動SQL更新の頻発

**パターン**:
- 本番環境での手動SQL更新が常態化（11件）

**原因**:
1. マイグレーション機能の未整備
2. スキーマ変更手順の標準化不足
3. 開発環境と本番環境の差異

**推奨アクション**:
- CakePHP Migrationsの導入
- Infrastructure as Code (IaC) の実践
- CI/CDパイプラインへの組み込み

### 3.4 PostgreSQL→MySQL移行の長期化

**パターン**:
- 2025年7月開始から5ヶ月経過、Phase2未着手

**ブロッカー**:
1. view_logs肥大化問題（解決済み）
2. recruitsテーブル削除（Phase2実施中）
3. 本番リリース手順の未確定

**推奨アクション**:
- 2025年Q1までに本番移行完了
- MySQL 5.7のEOL（2025年10月）を考慮

---

## 4. 被参照回数Top 10（DB関連issue）

| issue# | タイトル | 状態 | 被参照回数 | カテゴリ |
|--------|---------|------|-----------|---------|
| #2783 | PostgreSQL → MySQL 移行（既存＋新規2台構成） | Open | 15 | PostgreSQL→MySQL移行 |
| #3515 | PostgreSQL：view_logsテーブル 同期済データ削除 | Closed | 5 | view_logsテーブル |
| #2436 | PostgreSQL→MySQL統合｜差分調査・再着手準備 | Closed | 4 | PostgreSQL→MySQL移行 |
| #851 | plansTableのレコード追加と表示順位の変更 | Closed | 3 | スキーマ変更 |
| #2983 | Kill the History Button & Audit the DB Noise | Closed | 3 | その他 |
| #3130 | PostgreSQL→MySQL移行に向けたログテーブルの旧データ削除可否調査 | Closed | 3 | PostgreSQL→MySQL移行 |
| #3184 | PostgreSQL→MySQL移行に向けた`send_mails`、`use_numbers`テーブルの旧データ削除可否調査 | Closed | 3 | PostgreSQL→MySQL移行 |
| #3430 | PostgreSQL `view_logs`、`recruits` テーブルのアーカイブ影響範囲調査および移管方法・復旧計画検討 | Closed | 3 | view_logsテーブル |
| #3490 | 調査依頼：PostgreSQL側 `recruits` テーブル旧データアーカイブの影響範囲 | Closed | 3 | recruitsテーブル |
| #2393 | [Kanri パートナー] 効果測定ページの検索項目取得処理の最適化 | Closed | 2 | その他 |

**解釈**:
- #2783（PostgreSQL→MySQL移行）が圧倒的な被参照数（15回）
- view_logs関連issueが上位に集中
- PostgreSQL→MySQL移行関連が全体の40%を占める

---

## 5. 推奨アクション

### 優先度: 最高（即時実施）

1. **#3977: 原稿更新時の同期バッチ瞬断問題の解決**
   - 期限: 2025年1月末
   - 担当: VN + AA Tech Lead
   - 理由: ユーザー影響が最大

2. **#3854: SQLi脆弱性の修正**
   - 期限: 2025年1月末
   - 担当: セキュリティチーム
   - 理由: セキュリティインシデント再発防止

3. **#2783: PostgreSQL→MySQL移行の本番実施**
   - 期限: 2025年Q1
   - 担当: VN + AA Tech Lead
   - 理由: MySQL 5.7のEOL対応（2025年10月）

### 優先度: 高（3ヶ月以内）

4. **#3883: recruitsテーブル旧データ削除Phase2完了**
   - 期限: 2025年2月末
   - 担当: VN
   - 理由: DB統合の前提条件

5. **マイグレーション機能の実装**
   - 期限: 2025年3月末
   - 担当: VN + AA Tech Lead
   - 理由: 手動SQL更新のリスク排除

6. **本番SQL更新チェックリストの整備**
   - 期限: 2025年2月末
   - 担当: AA Tech Lead
   - 理由: オペレーションミス防止

### 優先度: 中（6ヶ月以内）

7. **未使用テーブルの削除（#3271, #3270, #3164, #3163）**
   - 期限: 2025年Q2
   - 担当: VN
   - 理由: コスト削減、メンテナンス性向上

8. **同期バッチの非同期化**
   - 期限: 2025年Q2
   - 担当: VN + AA Tech Lead
   - 理由: パフォーマンス改善

9. **Cloud SQL 8.0へのアップグレード（#3295）**
   - 期限: 2025年Q2
   - 担当: AA Infra
   - 理由: 延長サポート対応

---

## 6. リスク評価

| リスク | 影響度 | 発生確率 | リスクレベル | 対策状況 |
|-------|--------|---------|------------|---------|
| PostgreSQL→MySQL移行の遅延によるMySQL 5.7 EOL到達 | 高 | 中 | **高** | Phase1完了、Phase2未着手 |
| 同期バッチ瞬断問題の継続 | 高 | 高 | **高** | 調査中、未解決 |
| SQLi脆弱性の悪用 | 高 | 低 | 中 | 対応中 |
| 手動SQL更新によるヒューマンエラー | 中 | 中 | 中 | チェックリスト未整備 |
| recruitsテーブル削除の遅延 | 中 | 中 | 中 | Phase2実施中 |
| Cloud SQL CPU使用率の急上昇 | 中 | 低 | 低 | 監視済み、スケーリング対応済み |

---

## 7. KPI

### 現状値（2025-12-25時点）

| KPI | 現状値 | 目標値 | 達成率 |
|-----|--------|--------|--------|
| DB関連issue解決率 | 74.1% | 90% | 82.3% |
| 平均解決時間 | 39.3日 | 30日以下 | - |
| 本番SQL更新回数/月 | 1.0回 | 0回（マイグレーション化） | 0% |
| PostgreSQL→MySQL移行進捗 | Phase1完了 | Phase3完了 | 33% |
| セキュリティインシデント数 | 1件/年 | 0件/年 | - |

### 目標設定（2025年Q2）

| KPI | 目標値 |
|-----|--------|
| DB関連issue解決率 | 90%以上 |
| 平均解決時間 | 30日以下 |
| 本番SQL更新回数/月 | 0回（マイグレーション化） |
| PostgreSQL→MySQL移行進捗 | Phase3完了（100%） |
| セキュリティインシデント数 | 0件/年 |

---

## 8. まとめ

### 成果

1. **view_logsテーブル肥大化問題の解決**（11件→1件Open）
   - データ削減、アーカイブ、効果測定が完了
   - 瞬断問題が大幅に改善

2. **PostgreSQL→MySQL移行Phase1完了**
   - ローカル検証、事前調査、差分調査が完了
   - テーブル削除可否調査が完了

3. **セキュリティインシデントの迅速な対応**
   - SQLインジェクション試行を検知・調査
   - 影響範囲を特定し、対策を実施中

### 課題

1. **PostgreSQL→MySQL移行Phase2の停滞**
   - 2025年7月開始から5ヶ月経過、本番移行未実施
   - MySQL 5.7のEOL（2025年10月）が迫る

2. **同期バッチ瞬断問題の再発**
   - view_logs削減後も原稿更新時の瞬断が継続
   - 同期バッチのアーキテクチャ見直しが必要

3. **手動SQL更新の常態化**
   - 11件の本番SQL更新が発生
   - マイグレーション機能の未整備

### 提言

1. **DB統合プロジェクトの最優先実施**
   - 2025年Q1までに本番移行完了
   - 専任Tech Leadの配置検討

2. **パフォーマンス問題の根本解決**
   - 同期バッチの非同期化
   - アーキテクチャの抜本的見直し

3. **開発プロセスの標準化**
   - マイグレーション機能の実装
   - CI/CDパイプラインへの組み込み

---

**レポート作成者**: Claude Code
**データソース**: tools/issue-analyzer/data/issues.db
**分析対象期間**: 2025-01-06 〜 2025-12-24
**総issue数**: 387件（うちDB関連: 139件）
