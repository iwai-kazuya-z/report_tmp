# サーバーコスト削減 課題レポート

**作成日:** 2025-12-26
**対象読者:** 経営層、インフラ担当者
**ステータス:** ドラフト
**関連Issue:** [#3822 ドラピタ Staging環境のコスト最適化](https://github.com/ZIGExN/dorapita/issues/3822)

---

## エグゼクティブサマリー

### 目標

> **「最初期の状態」に近づける**
>
> 以前の合意額を基準とし、メモリ不足対応で増えたインスタンス分を考慮に入れる
> — 松本貴也氏

### 現状コスト（2025年10月実績）

| 環境 | 月額 | Cloud SQL比率 | 備考 |
|------|------|---------------|------|
| **本番 (Production)** | **約$2,480（≒37.2万円）** | 52% | 安定稼働、構成適正 |
| **ステージング (Staging)** | **約$1,700（≒25.5万円）** | 51% | **過剰構成** |
| **MySQL延長サポート費用** | **¥136,713/月** | - | **EOL製品への上乗せ費用** |
| **合計** | **約$4,180 + ¥136,713（≒76.4万円）** | - | |

### 削減ポテンシャル

| 施策 | 削減額/月 | 年間削減 |
|------|----------|---------|
| **MySQL 8.0アップグレード（延長サポート解消）** | **¥136,713** | **¥164万円** |
| ステージング Cloud SQL最適化 | ¥60,000〜105,000 | ¥72〜126万円 |
| ステージング稼働スケジュール調整 | ¥30,000〜45,000 | ¥36〜54万円 |
| その他リソース整理 | ¥20,000〜40,000 | ¥24〜48万円 |
| **合計削減効果** | **¥25〜33万円** | **¥296〜392万円** |

### 最優先アクション

1. **MySQL 8.0アップグレード**（延長サポート費用解消）→ **月13.7万円削減**
2. **Cloud SQLの再作成**（ディスク容量削減）→ 月5〜10万円削減
3. **ステージング夜間・休日停止**（Cloud Scheduler活用）→ 月2〜3万円削減
4. **停止中VMの削除**（ディスク料金のみ発生中）→ 月数千円削減

---

## 1. 現状のインフラ構成と課題

### 1.1 環境比較

| リソース | 本番 (core) | ステージング (core-dev) | 問題点 |
|---------|-------------|------------------------|--------|
| **Compute Engine** | 6台稼働 | 5台稼働 + 3台停止 | STGで停止VMが3台残存 |
| **Cloud SQL** | 2インスタンス | 2インスタンス | STGのディスク肥大化 |
| **Cloud Run** | 3サービス | **7サービス** | STGが本番より多い |
| **Filestore** | 1TB | 1TB | STGで1TBは過剰 |
| **Memorystore** | 1GB | 1GB | 適正 |
| **Load Balancer** | 7エンドポイント | **26エンドポイント** | STGが過剰 |

### 1.2 ステージング環境の問題点

```
┌──────────────────────────────────────────────────────────────────┐
│                ステージング環境の無駄なリソース                    │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  🔴 Cloud SQL ディスク肥大化                                      │
│     └── 自動拡張されたディスクは縮小不可                           │
│     └── 再作成が必要（岩井氏指摘）                                 │
│                                                                  │
│  🟡 停止中VM 3台                                                 │
│     └── gw-120011 (e2-small) - TERMINATED                        │
│     └── pg-120010 (n2-standard-2) - TERMINATED                   │
│     └── web-120012 (e2-medium) - TERMINATED                      │
│     └── ディスク料金が継続発生                                    │
│                                                                  │
│  🟡 Cloud Run 7サービス（本番は3サービス）                         │
│     └── api-dorapita-com                                         │
│     └── cadm-dorapita-com                                        │
│     └── dorapita-com                                             │
│     └── dorapita-maintenance                                     │
│     └── edit-dorapita-com                                        │
│     └── help-dorapita-com                                        │
│     └── img-dorapita-com                                         │
│     └── 本番と構成が異なる（VMとCloud Runの混在テスト？）           │
│                                                                  │
│  🟡 Load Balancer 26エンドポイント                                │
│     └── 本番は7エンドポイント                                     │
│     └── 未使用のエンドポイントが多数ある可能性                      │
│                                                                  │
│  🟡 Filestore 1TB                                                │
│     └── ステージングで1TBは過剰                                   │
│     └── BASIC_HDD最小容量は1TBだが、Enterprise版なら縮小可能       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. コスト削減施策

### 2.0 優先度: 最高 - MySQL延長サポート費用の解消

#### 背景

**MySQL 5.7は2023年10月にEOL（End of Life）を迎えました。** 現在、延長サポート（Extended Support）として**毎月¥136,713**が上乗せされています。

```
┌──────────────────────────────────────────────────────────────────┐
│              MySQL延長サポート費用の内訳                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│   MySQL 5.7 EOL: 2023年10月                                      │
│   ↓                                                              │
│   延長サポート開始（2023年11月〜）                                 │
│   ↓                                                              │
│   毎月 ¥136,713 が追加課金                                        │
│   ↓                                                              │
│   年間 ¥164万円 の無駄なコスト                                    │
│                                                                  │
│   💡 MySQL 8.0へアップグレードすれば即座に解消                     │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

#### 施策

| 項目 | 内容 |
|------|------|
| **対象** | db-120011 (MySQL 5.7)（本番・ステージング両方） |
| **手順** | 1. ステージングで8.0アップグレード検証 → 2. 本番適用 |
| **リスク** | アプリケーション互換性（事前検証必須） |
| **削減効果** | **月¥136,713、年間¥164万円** |

#### MySQL 5.7 → 8.0 の主な変更点

| 変更点 | 影響 | 対応 |
|--------|------|------|
| デフォルト認証プラグイン変更 | 接続エラーの可能性 | `mysql_native_password`に設定 |
| 予約語の追加 | クエリエラーの可能性 | バッククォートで囲む |
| GROUP BY暗黙的ソートの廃止 | 結果順序の変化 | ORDER BY明示 |
| utf8mb4デフォルト化 | 文字化けの可能性 | 照合順序確認 |

#### アップグレード手順（概要）

```bash
# 1. ステージングでアップグレード検証
gcloud sql instances patch db-120011 \
  --database-version=MYSQL_8_0 \
  --project=dorapita-core-dev

# 2. アプリケーション動作確認（VNチームと連携）

# 3. 本番適用（メンテナンス時間を設定）
gcloud sql instances patch db-120011 \
  --database-version=MYSQL_8_0 \
  --project=dorapita-core
```

#### 関連

- DB統合プロジェクト（PostgreSQL→MySQL移行）と連携して実施
- MySQL 8.0化 → PostgreSQL廃止 → 単一DB運用へ

---

### 2.1 優先度: 高 - Cloud SQL再作成

#### 背景

Cloud SQLは自動ストレージ拡張が有効な場合、ディスク容量が自動で増加しますが、**一度増加したディスクは縮小できません**。これがステージング環境のコスト増の主要因です。

#### 施策

| 項目 | 内容 |
|------|------|
| **対象** | pg-120011 (PostgreSQL 10)、db-120011 (MySQL 5.7) |
| **手順** | 1. データエクスポート → 2. インスタンス削除 → 3. 小容量で新規作成 → 4. データインポート |
| **リスク** | 数時間のダウンタイム（ステージングなので影響小） |
| **削減効果** | 月5〜10万円（ディスク容量による） |

#### 注意点

- **自動ストレージ拡張を無効化**して再作成
- 適正なディスクサイズを設定（例: 20GB → 必要最小限）
- PostgreSQL 10 → 16、MySQL 5.7 → 8.0 への移行も同時検討

#### 手順概要

```bash
# 1. データエクスポート
gcloud sql export sql pg-120011 gs://dorapita-core-dev-archives/pg-120011-backup.sql

# 2. インスタンス削除
gcloud sql instances delete pg-120011

# 3. 小容量で新規作成（例: 10GB、自動拡張オフ）
gcloud sql instances create pg-120011-new \
  --database-version=POSTGRES_16 \
  --tier=db-custom-2-4096 \
  --storage-size=10GB \
  --storage-auto-increase=off \
  --region=asia-northeast1

# 4. データインポート
gcloud sql import sql pg-120011-new gs://dorapita-core-dev-archives/pg-120011-backup.sql
```

---

### 2.2 優先度: 高 - ステージング夜間・休日停止

#### 背景

Issue #3822で提案されているように、ステージング環境は24時間稼働する必要がありません。

#### 施策

| 項目 | 内容 |
|------|------|
| **対象** | Cloud SQL (db-120011, pg-120011)、Compute Engine |
| **停止時間（案）** | 平日22:00〜翌8:00、土日終日 |
| **手法** | Cloud Scheduler + SQL Admin API |
| **削減効果** | 月¥30,000〜45,000（≒$200〜300） |

#### 停止スケジュール例

```
月 火 水 木 金 土 日
├─┼─┼─┼─┼─┼─┼─┤
│▓│▓│▓│▓│▓│░│░│  ← 日中稼働
│░│░│░│░│░│░│░│  ← 夜間停止

▓ = 稼働 (08:00-22:00)
░ = 停止 (22:00-08:00、土日終日)

稼働率: 14h × 5日 = 70h / 168h = 約42%
削減効果: 58%の時間で停止 = 約60%のコスト削減（Cloud SQLの場合）
```

#### Cloud Scheduler設定例

```bash
# 平日22:00に停止
gcloud scheduler jobs create http stop-staging-sql \
  --schedule="0 22 * * 1-5" \
  --uri="https://sqladmin.googleapis.com/v1/projects/dorapita-core-dev/instances/db-120011/stop" \
  --oauth-service-account-email=<SA>

# 平日08:00に起動
gcloud scheduler jobs create http start-staging-sql \
  --schedule="0 8 * * 1-5" \
  --uri="https://sqladmin.googleapis.com/v1/projects/dorapita-core-dev/instances/db-120011/start" \
  --oauth-service-account-email=<SA>
```

#### ビジネス合意

- 代田さん承認OK（Issue #3822より）
- 具体的な停止時間はビジネス側と最終調整

---

### 2.3 優先度: 中 - 停止中VMの削除

#### 対象リソース

| VM名 | マシンタイプ | ステータス | 推定ディスク料金/月 |
|------|-------------|-----------|-------------------|
| gw-120011 | e2-small | TERMINATED | 〜1,000円 |
| pg-120010 | n2-standard-2 | TERMINATED | 〜2,000円 |
| web-120012 | e2-medium | TERMINATED | 〜1,500円 |
| **合計** | | | **〜4,500円/月** |

#### 施策

1. 各VMの用途を確認（不要なら削除）
2. 必要なデータがあればスナップショット取得後に削除
3. 将来必要になる可能性があるならマシンイメージを作成

#### 手順

```bash
# スナップショット作成（必要な場合）
gcloud compute disks snapshot gw-120011-disk --zone=asia-northeast1-b

# VM削除
gcloud compute instances delete gw-120011 --zone=asia-northeast1-b
```

---

### 2.4 優先度: 中 - Cloud Runサービスの整理

#### 現状分析

| サービス | 本番 | STG | 備考 |
|----------|------|-----|------|
| api-dorapita-com | - | ✅ | STGのみ（新API開発？） |
| cadm-dorapita-com | - | ✅ | STGのみ（本番はVM） |
| dorapita-com | - | ✅ | STGのみ（本番はVM） |
| dorapita-maintenance | ✅ | ✅ | 両環境 |
| edit-dorapita-com | - | ✅ | STGのみ（本番はVM） |
| help-dorapita-com | ✅ | ✅ | 両環境 |
| img-dorapita-com | ✅ | ✅ | 両環境 |

#### 施策

1. **api-dorapita-com**: 開発用であれば継続、未使用なら削除
2. **cadm, dorapita-com, edit**: 本番と構成を合わせるか、統合を検討
3. 最小インスタンス数を0に設定（アイドル時のコスト削減）

#### 設定変更

```bash
# 最小インスタンス数を0に設定（コスト削減）
gcloud run services update cadm-dorapita-com \
  --min-instances=0 \
  --region=asia-northeast1
```

#### 削減効果

- 未使用サービスの削除: 月1〜2万円
- min-instances=0設定: アイドル時のコスト大幅削減

---

### 2.5 優先度: 低 - Load Balancerの整理

#### 現状

- ステージング: **26エンドポイント**
- 本番: 7エンドポイント

#### 施策

1. 未使用のエンドポイントを特定
2. 不要な転送ルール、バックエンドサービスを削除
3. SSL証明書の重複を解消

#### 調査コマンド

```bash
# 転送ルール一覧
gcloud compute forwarding-rules list --project=dorapita-core-dev

# バックエンドサービス一覧
gcloud compute backend-services list --project=dorapita-core-dev

# 未使用のバックエンドを特定
gcloud compute backend-services describe <service-name> --global
```

#### 削減効果

- 転送ルール1つあたり: 月〜2,000円
- 10個削減で: 月〜2万円

---

### 2.6 優先度: 低 - Filestoreの見直し

#### 現状

| 環境 | Tier | 容量 | 月額（推定） |
|------|------|------|-------------|
| 本番 | BASIC_HDD | 1TB | 約2万円 |
| STG | BASIC_HDD | 1TB | 約2万円 |

#### 課題

- **BASIC_HDDは最小1TB**（縮小不可）
- ステージングで1TBは過剰

#### 選択肢

| 選択肢 | 容量 | 月額（推定） | 備考 |
|--------|------|-------------|------|
| A. 現状維持 | 1TB | 約2万円 | - |
| B. Cloud Storageに移行 | 可変 | 〜5,000円 | FUSEマウント、低速 |
| C. Persistent Disk (SSD) | 50GB | 〜1,500円 | VMにマウント |
| D. Filestore Enterprise | 256GB〜 | 〜1.5万円 | 最小容量が小さい |

#### 推奨

**選択肢C（Persistent Disk）** をステージング環境に適用

- 画像テストデータは50GB以下で十分
- 本番同等のテストが不要な場合はコスト優先

---

### 2.7 優先度: 低 - その他の最適化

#### Memorystore Redis

- 現状: BASIC 1GB（月約5,000円）
- STGでは0.5GBでも十分な可能性あり

#### Cloud Storage

- 古いビルドアーティファクトの削除
- ライフサイクルポリシーの設定（30日後に削除等）

```bash
# ライフサイクルポリシー設定
gsutil lifecycle set lifecycle.json gs://dorapita-core-dev_cloudbuild
```

---

## 3. コスト削減ロードマップ

### Phase 1: 即時実施（1週間以内）

| 施策 | 担当 | 削減効果/月 |
|------|------|------------|
| 停止中VMの削除 | Infra (MT) | ¥4,500 |
| Cloud Run min-instances=0設定 | Infra (MT) | ¥5,000〜10,000 |
| Cloud Storage ライフサイクル設定 | Infra (MT) | ¥数千円 |
| **小計** | | **¥1〜2万円** |

### Phase 2: 短期実施（1ヶ月以内）

| 施策 | 担当 | 削減効果/月 |
|------|------|------------|
| **Cloud SQL再作成（ディスク容量削減）** | Infra + VN | **¥5〜10万円** |
| ステージング夜間・休日停止 | Infra (MT) | ¥3〜4.5万円 |
| 未使用Cloud Runサービス削除 | Infra | ¥1〜2万円 |
| **小計** | | **¥9〜16.5万円** |

### Phase 3: 中期実施（3ヶ月以内）

| 施策 | 担当 | 削減効果/月 |
|------|------|------------|
| **MySQL 8.0アップグレード（延長サポート解消）** | Infra + VN | **¥136,713** |
| Load Balancer整理 | Infra | ¥1〜2万円 |
| Filestore見直し | Infra | ¥1〜2万円 |
| **小計** | | **¥15〜17万円** |

### Phase 4: 長期実施（6ヶ月以内）

| 施策 | 担当 | 削減効果/月 |
|------|------|------------|
| DB統合（PostgreSQL廃止→MySQL一本化） | VN + Infra | ¥3〜5万円 |
| 本番・STG構成の統一 | VN + Infra | 運用効率化 |
| **小計** | | **¥3〜5万円** |

---

## 4. 削減効果まとめ

### 全体コスト削減

| 施策 | 月額削減 | 年間削減 | 優先度 |
|------|---------|---------|--------|
| **MySQL 8.0アップグレード（延長サポート解消）** | **¥136,713** | **¥164万円** | 🔴 最高 |
| Cloud SQL再作成（ディスク容量削減） | ¥5〜10万円 | ¥60〜120万円 | 🔴 高 |
| ステージング夜間・休日停止 | ¥3〜4.5万円 | ¥36〜54万円 | 🟡 高 |
| 停止中VM削除 | ¥4,500 | ¥5.4万円 | 🟢 中 |
| Cloud Run整理 | ¥1〜2万円 | ¥12〜24万円 | 🟢 中 |
| Load Balancer整理 | ¥1〜2万円 | ¥12〜24万円 | 🟢 低 |
| Filestore見直し | ¥1〜2万円 | ¥12〜24万円 | 🟢 低 |
| DB統合（PostgreSQL廃止） | ¥3〜5万円 | ¥36〜60万円 | 🟡 中長期 |
| **合計** | **¥28〜40万円** | **¥340〜480万円** |

### 現状 vs 目標

```
現状（2025年10月）:
┌─────────────────────────────────────────────────┐
│ 本番:      ¥37.2万円/月                         │
│ STG:       ¥25.5万円/月                         │
│ 延長サポート: ¥13.7万円/月                       │
│ ─────────────────────────────────               │
│ 合計:      ¥76.4万円/月                         │
└─────────────────────────────────────────────────┘

目標（削減後）:
┌─────────────────────────────────────────────────┐
│ 本番:      ¥37.2万円/月（維持）                  │
│ STG:       ¥10〜15万円/月（▲40〜60%削減）        │
│ 延長サポート: ¥0（MySQL 8.0化で解消）             │
│ ─────────────────────────────────               │
│ 合計:      ¥47〜52万円/月                        │
│ ─────────────────────────────────               │
│ 削減額:    ¥24〜29万円/月（▲31〜38%削減）         │
└─────────────────────────────────────────────────┘
```

### 目標達成度

| 項目 | 現状 | 目標 | 達成見込み |
|------|------|------|-----------|
| 月額コスト | ¥76.4万円 | ¥47〜52万円 | ✅ |
| STG/本番比率 | 69% | 30〜40% | ✅ |
| 延長サポート費用 | ¥13.7万円 | ¥0 | ✅（MySQL 8.0化） |
| 「最初期の状態」 | - | - | **達成見込み** |

---

## 5. リスクと注意点

| リスク | 影響 | 対策 |
|--------|------|------|
| Cloud SQL再作成時のデータ損失 | 高 | 複数バックアップ取得、手順書作成 |
| VM削除後に必要だったと判明 | 中 | 削除前にスナップショット取得 |
| Cloud Run削除後にテスト不能 | 中 | 削除前にVNチームに確認 |
| Filestore移行時のアプリ修正 | 中 | 移行先のパス互換性確認 |

---

## 6. 次のアクション

### 即時（今週中）

| アクション | 担当 | 備考 |
|-----------|------|------|
| Cloud SQLのリソース使用実績を抽出 | 岩井 | Stackdriverで30日分取得 |
| 停止中VM用途確認・削除判断 | AA | gw-120011, pg-120010, web-120012 |
| Cloud Run利用状況確認 | VN | 未使用サービスの特定 |

### 短期（1ヶ月以内）

| アクション | 担当 | 備考 |
|-----------|------|------|
| Cloud SQL再作成計画策定 | 岩井 + MT | ディスク容量削減 |
| 夜間・休日停止スクリプト検証 | MT | Cloud Scheduler + SQL Admin API |
| MySQL 8.0アップグレード検証（STG） | VN + Infra | 延長サポート解消に向けて |

### 中期（3ヶ月以内）

| アクション | 担当 | 備考 |
|-----------|------|------|
| MySQL 8.0アップグレード（本番） | VN + Infra | 延長サポート費用¥13.7万円/月解消 |
| Billing ExportでBefore/Afterのコスト比較 | 岩井 | 効果検証 |
| DB統合（PostgreSQL廃止）計画 | VN + Infra | 単一DB運用へ |

---

## 7. 関連情報

| リソース | リンク |
|---------|--------|
| Issue #3822 | [ドラピタ Staging環境のコスト最適化](https://github.com/ZIGExN/dorapita/issues/3822) |
| GCPコンソール（STG） | [dorapita-core-dev](https://console.cloud.google.com/home/dashboard?project=dorapita-core-dev) |
| GCPコンソール（本番） | [dorapita-core](https://console.cloud.google.com/home/dashboard?project=dorapita-core) |
| Cloud SQL料金 | [料金ページ](https://cloud.google.com/sql/pricing) |

---

**更新履歴:**

| 日付 | 内容 | 更新者 |
|------|------|--------|
| 2025-12-26 | 初版作成 | Claude Code |
| 2025-12-26 | MySQL延長サポート費用（¥136,713/月）を追加、実績コストを反映 | Claude Code |

---

*本レポートに関するご質問・ご意見は、Issue #3822 または Slack #dorapita-infra にてお願いします。*
